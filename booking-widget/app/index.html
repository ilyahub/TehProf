<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Booking Hook — только Booking API (полная диагностика)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.bitrix24.com/api/v1/"></script>
  <style>
    :root{--fg:#111827;--muted:#6b7280;--ok:#059669;--warn:#d97706;--err:#b91c1c;--bd:#e5e7eb}
    body{font-family:system-ui,Arial,sans-serif;margin:24px;max-width:1200px;color:var(--fg)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{border:1px solid var(--bd);border-radius:12px;padding:16px;margin:12px 0}
    .muted{color:var(--muted)}
    .list{max-height:420px;overflow:auto;border:1px solid var(--bd);border-radius:10px;padding:8px}
    .btn{padding:10px 16px;border-radius:10px;border:1px solid var(--fg);cursor:pointer;background:#fff}
    .btn.primary{background:var(--fg);color:#fff}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    input[type="search"],input[type="text"]{padding:8px 12px;border:1px solid var(--bd);border-radius:10px}
    input[type="text"]{width:520px}
    label.item{display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:8px}
    label.item:hover{background:#f9fafb}
    small{color:var(--muted)}
    code{background:#f8fafc;padding:2px 6px;border-radius:6px;border:1px solid var(--bd)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--bd);font-size:12px}
    .kbd{font-family:ui-monospace,Menlo,Consolas,monospace}
    .hr{height:1px;background:var(--bd);margin:12px 0}
    table{border-collapse:collapse;width:100%;font-size:14px}
    td,th{border:1px solid var(--bd);padding:6px 8px;text-align:left}
    th{background:#f9fafb}
  </style>
</head>
<body>
  <h2>Онлайн-запись (Booking API): выбор <u>ресурсов</u> и регистрация onBooking-событий</h2>
  <p class="muted">Здесь всё крутится только вокруг модуля <b>Онлайн-запись</b> (Booking API). Календарь не используется.</p>

  <div class="card">
    <div class="row" style="gap:16px">
      <input id="q" type="search" placeholder="Поиск по названию ресурса…" />
      <button id="reload" class="btn">Обновить список</button>
      <span id="portal-tag" class="pill muted"></span>
      <span id="mode-tag" class="pill ok">режим: Booking</span>
    </div>
    <div id="list" class="list muted">Загрузка…</div>
  </div>

  <div class="card">
    <div class="row">
      <label>Хендлер (Cloudflare):</label>
      <input id="handler" type="text" value="https://booking-widget-d47.pages.dev/api/bitrix-hook" />
    </div>
    <div class="row" style="margin-top:10px">
      <button id="bind" class="btn primary">Подписать onBookingAdd / onBookingUpdate</button>
      <button id="unbind" class="btn">Снять все подписки</button>
      <button id="selftest" class="btn">Самотест</button>
    </div>
    <p class="muted" style="margin-top:8px">
      В хендлер будет передан параметр <code>?resources=ID1,ID2</code>. Никаких <code>?sections</code>, TZ и календарей.
    </p>
  </div>

  <div class="card">
    <b>Статус</b>
    <div class="hr"></div>
    <pre id="log" style="white-space:pre-wrap;margin:0"></pre>
  </div>

  <div class="card">
    <b>Диагностика (резюме)</b>
    <div class="hr"></div>
    <table id="diag-table">
      <thead><tr><th>Проверка</th><th>Результат</th><th>Комментарий</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

<script>
/* ===== helpers ===== */
const logEl=document.getElementById('log');
const listEl=document.getElementById('list');
const qEl=document.getElementById('q');
const handlerEl=document.getElementById('handler');
const portalTag=document.getElementById('portal-tag');
const modeTag=document.getElementById('mode-tag');
const diagBody=document.querySelector('#diag-table tbody');

function log(msg, cls){const d=document.createElement('div');if(cls)d.className=cls;d.textContent=msg;logEl.appendChild(d);}
function rowProbe(name,res,note,cls){const tr=document.createElement('tr');const a=document.createElement('td');a.textContent=name;const b=document.createElement('td');b.textContent=res;b.className=cls||'';const c=document.createElement('td');c.textContent=note||'';tr.append(a,b,c);diagBody.appendChild(tr);}
function validHandler(u){try{const x=new URL((u||'').trim());return /^https:$/i.test(x.protocol);}catch{return false;}}
function mkRow(r){const lbl=document.createElement('label');lbl.className='item';const cb=document.createElement('input');cb.type='checkbox';cb.value=String(r.id);const name=document.createElement('span');name.textContent=r.name||'(без названия)';const small=document.createElement('small');small.textContent=`#${r.id} • ${r.status||'active'}`;lbl.append(cb,name,small);lbl.dataset.name=(r.name||'').toLowerCase();return lbl;}
function filter(){const q=qEl.value.trim().toLowerCase();Array.from(listEl.querySelectorAll('label.item')).forEach(el=>{el.style.display=!q||el.dataset.name.includes(q)?'':'';});}
function selectedIds(){return Array.from(listEl.querySelectorAll('input[type=checkbox]:checked')).map(x=>x.value);}
function sameBase(h){try{const u=new URL(h);const b=new URL(handlerEl.value);return (u.origin+u.pathname)===(b.origin+b.pathname);}catch{return false;}}
function idsFromHandler(h){try{const u=new URL(h);return (u.searchParams.get('resources')||'').split(',').filter(Boolean);}catch{return[];}}

/* ===== BX24 wrappers ===== */
const pCall=(m,p={})=>new Promise(res=>{try{BX24.callMethod(m,p,r=>{try{if(r&&typeof r.error==='function'&&r.error()){res({ok:false,error:r.error(),desc:(r.error_description&&r.error_description())||'',data:null});}else{res({ok:true,data:(r&&r.data&&r.data())||null});}}catch(e){res({ok:false,error:String(e)})}});}catch(e){res({ok:false,error:String(e)})}}));

/* ===== ENV ===== */
async function getEnv(){return new Promise(resolve=>{BX24.callMethod('app.info',{},r=>{let domain='',scope=[];try{const d=r.data();domain=d.domain||d.DOMAIN||'';scope=d.scope||d.SCOPE||[];}catch{}resolve({domain,scope:Array.isArray(scope)?scope:[]});});});}

/* ===== Booking loaders & diagnostics ===== */
async function loadResources(){
  const items=[];let page=1,iter=0;
  while(iter++<50){
    const r=await pCall('booking.v1.resource.list',{select:['id','name','status'],page});
    if(!r.ok){rowProbe('Resources','Ошибка',`${r.error||''} ${r.desc||''}`,'err');break;}
    const chunk=(r.data&&(r.data.items||r.data))||[];
    if(Array.isArray(chunk)) items.push(...chunk);
    const next=(r.data&&(r.data.next??null));
    if(!next||!chunk.length)break;
    page=typeof next==='number'?next:page+1;
  }
  rowProbe('Resources',String(items.length),items.length?'ОК':'Пусто',items.length?'ok':'warn');
  return items;
}

async function diagServices(){
  const r=await pCall('booking.v1.service.list',{select:['id','name','duration','active'],limit:100});
  if(r.ok){const arr=(r.data?.items||r.data||[]);rowProbe('Services',String(arr.length),arr.length?'ОК':'Нет услуг',arr.length?'ok':'warn');}
  else{rowProbe('Services','Ошибка',`${r.error||''} ${r.desc||''}`,'err');}
}

async function diagSlots(resourceIds){
  const now=new Date();const to=new Date(now.getTime()+7*86400000);
  const iso=d=>d.toISOString().slice(0,19)+'+00:00';
  const r=await pCall('booking.v1.slot.list',{filter:{dateFrom:iso(now),dateTo:iso(to),resourceIds:(resourceIds||[]).slice(0,3)}});
  if(r.ok){const arr=(r.data?.items||r.data||[]);rowProbe('Slots (7d)',Array.isArray(arr)?String(arr.length):'есть',Array.isArray(arr)&&!arr.length?'нет доступных окон':'',Array.isArray(arr)&&arr.length?'ok':'warn');}
  else{const ee=String(r.error||'').toLowerCase();if(ee.includes('method_not_found'))rowProbe('Slots (7d)','Нет метода','booking.v1.slot.list отсутствует — не критично','warn');else rowProbe('Slots (7d)','Ошибка',`${r.error||''} ${r.desc||''}`,'err');}
}

async function diagBookings(resourceIds){
  const now=new Date();const from=new Date(now.getTime()-7*86400000);const to=new Date(now.getTime()+30*86400000);
  const iso=d=>d.toISOString().slice(0,19)+'+00:00';
  const r=await pCall('booking.v1.booking.list',{filter:{dateFrom:iso(from),dateTo:iso(to),resourceIds:resourceIds||[]},select:['id','status'],limit:100});
  if(r.ok){const arr=(r.data?.items||r.data||[]);rowProbe('Bookings (−7..+30d)',String(arr.length),'',arr.length?'ok':'warn');}
  else{rowProbe('Bookings (−7..+30d)','Ошибка',`${r.error||''} ${r.desc||''}`,'err');}
}

/* ===== Render list & actions ===== */
function renderList(items){
  listEl.innerHTML='';
  if(!items.length){listEl.textContent='Ресурсы не найдены (Booking)';return;}
  items.forEach(x=>listEl.appendChild(mkRow(x)));
  preselect(); filter();
}

function preselect(){
  BX24.callMethod('event.get',{},r=>{
    if(r.error&&r.error())return;
    const binds=(r.data&&r.data())||[];
    const mine=binds.filter(b=>sameBase(b.handler));
    if(!mine.length){log('Наших подписок пока нет.','muted');return;}
    const ids=new Set(); mine.forEach(b=>idsFromHandler(b.handler).forEach(x=>ids.add(x)));
    listEl.querySelectorAll('input[type=checkbox]').forEach(cb=>{if(ids.has(cb.value))cb.checked=true;});
    log(`Активные подписки: ${mine.map(x=>x.event).join(', ')}; resources=[${Array.from(ids).join(',')||'—'}]`);
  });
}

function bind(){
  const ids=selectedIds();
  if(!ids.length){alert('Выбери хотя бы один ресурс');return;}
  if(!validHandler(handlerEl.value)){alert('Некорректный Handler URL');return;}

  // снимаем прежние на этот handler
  BX24.callMethod('event.get',{},r=>{
    if(!r.error||!r.error())(r.data()||[]).filter(b=>sameBase(b.handler)).forEach(b=>BX24.callMethod('event.unbind',{event:b.event,handler:b.handler},()=>{}));
  });

  const u=new URL((handlerEl.value||'').trim());
  u.searchParams.set('resources',ids.join(','));
  const h=u.toString();

  ['onBookingAdd','onBookingUpdate'].forEach(ev=>{
    BX24.callMethod('event.bind',{event:ev,handler:h},res=>{
      if(res.error&&res.error())log(`bind ${ev}: ${res.error()} / ${(res.error_description&&res.error_description())||''}`,'err');
      else log(`OK bind ${ev} → ${h}`,'ok');
    });
  });
}

function unbind(){
  BX24.callMethod('event.get',{},r=>{
    if(r.error&&r.error()){log(`event.get: ${r.error()} / ${(r.error_description&&r.error_description())||''}`,'err');return;}
    (r.data()||[]).filter(b=>sameBase(b.handler)).forEach(b=>{
      BX24.callMethod('event.unbind',{event:b.event,handler:b.handler},res=>{
        if(res.error&&res.error())log(`unbind ${b.event}: ${res.error()} / ${(res.error_description&&res.error_description())||''}`,'err');
        else log(`Снята подписка ${b.event}`,'ok');
      });
    });
  });
}

/* ===== Page flow ===== */
async function loadAll(){
  diagBody.innerHTML='';
  listEl.classList.add('muted'); listEl.textContent='Загрузка…';
  try{
    const env=await getEnv(); portalTag.textContent=env.domain?('portal: '+env.domain):'портал: ?';
    rowProbe('Scopes', env.scope.join(', ')||'—', 'Нужны: booking (для API) и event (для подписок)', (env.scope.includes('booking')&&env.scope.includes('event'))?'ok':'warn');

    // Быстрый «ping» Booking
    const ping=await pCall('booking.v1.resource.list',{select:['id'],limit:1});
    if(ping.ok){rowProbe('Booking API','OK','booking.v1.resource.list доступен','ok');}
    else{rowProbe('Booking API','Ошибка',`${ping.error||''} ${ping.desc||''}`,'err'); listEl.textContent='Booking API недоступен'; return;}

    // Основные данные
    const resources=await loadResources();
    renderList(resources);
    await diagServices();
    await diagSlots(resources.map(x=>x.id));
    await diagBookings(resources.map(x=>x.id));
  }catch(e){
    listEl.textContent='Ошибка загрузки';
    rowProbe('loadAll','Ошибка',String(e),'err');
    log('loadAll error: '+String(e),'err');
  }finally{
    listEl.classList.remove('muted');
  }
}

/* ===== Self-test ===== */
async function selftest(){
  diagBody.innerHTML='';
  rowProbe('В iframe', String(window!==window.top),'Виджет работает внутри Bitrix24','muted');
  await loadAll();
}

/* ===== Hooks ===== */
document.getElementById('bind').onclick=bind;
document.getElementById('unbind').onclick=unbind;
document.getElementById('reload').onclick=loadAll;
document.getElementById('selftest').onclick=selftest;
document.getElementById('q').oninput=filter;

BX24.init(async()=>{ log('BX24 инициализировано. Загружаю…','muted'); await loadAll(); });
</script>
</body>
</html>
